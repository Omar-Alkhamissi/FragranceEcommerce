import{Q as U}from"./QInput-CWT21_Re.js";import{Q as $}from"./QBtn-mnL5sTwx.js";import{O as y,q as P,x as u,t as x,v as L,P as S,ah as b,y as j,r as z,f as N}from"./index-CrptOnIy.js";import{_ as E}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-key-composition-JJpNaAnY.js";import"./focus-manager-SXuRI9xq.js";const I={name:"BranchePage",setup(){const m=z(null);let t=N({status:"",address:"T5A 0A3",showmap:!1});return{mapRef:m,state:t,findClosestBranches:async()=>{try{t.status="Finding branches...",t.showmap=!0;const e=window.tt;let r=t.address.trim();if(r.match(/^[A-Za-z]\d[A-Za-z][\s-]?\d[A-Za-z]\d$/)){let o=r.replace(/[-\s]/g,"");r=o.substring(0,3)+" "+o.substring(3)}console.log("Searching for:",r);let n=`https://api.tomtom.com/search/2/geocode/${encodeURIComponent(r)}.json?key=Hyxyimv7jPnUdwKFnzcAcAcjaUQEWPzB`;console.log("Geocoding URL:",n);let l=await fetch(n),s=await l.json();if(console.log("Full geocoding response:",s),(!s.results||s.results.length===0)&&(console.log("First attempt failed, trying with country..."),n=`https://api.tomtom.com/search/2/geocode/${encodeURIComponent(r+", Canada")}.json?key=Hyxyimv7jPnUdwKFnzcAcAcjaUQEWPzB`,console.log("Second geocoding URL:",n),l=await fetch(n),s=await l.json(),console.log("Second geocoding response:",s),!s.results||s.results.length===0)){t.status=`Address not found. Response: ${JSON.stringify(s)}`;return}let d=parseFloat(s.results[0].position.lat),i=parseFloat(s.results[0].position.lon);console.log("Coordinates found:",d,i),console.log("Found location:",s.results[0].address?.freeformAddress);const f=JSON.parse(sessionStorage.getItem("customer")||"{}");if(!f.token){t.status="Please login first to find branches";return}let w=`/api/Branch/${d}/${i}`;console.log("Branch API URL:",w);let c=await fetch(w,{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+f.token}});if(console.log("Branch response status:",c.status),!c.ok){const o=await c.text();throw console.log("Branch API error response:",o),new Error(`Branch API error: ${c.status} - ${o}`)}let g=await c.text();console.log("Branch API response:",g);let a;try{a=JSON.parse(g)}catch(o){throw console.error("JSON parse error:",o),new Error(`Invalid JSON response: ${g}`)}if(console.log("Parsed branches:",a),!a||a.length===0){t.status="No branches found";return}let p=e.map({key:"Hyxyimv7jPnUdwKFnzcAcAcjaUQEWPzB",container:m.value,source:"vector/1/basic-main",center:[i,d],zoom:8});p.addControl(new e.FullscreenControl),p.addControl(new e.NavigationControl);const h=new e.LngLatBounds;let C=new e.Marker({color:"red"}).setLngLat([i,d]).addTo(p),v=new e.Popup({offset:25});v.setHTML(`<div>Search Location<br/>${r}</div>`),C.setPopup(v),h.extend([i,d]),a.forEach(o=>{h.extend([o.longitude,o.latitude]);let k=new e.Marker().setLngLat([o.longitude,o.latitude]).addTo(p),F=25,B=new e.Popup({offset:F});B.setHTML(`<div id="popup">Branch# ${o.id}</div><div>${o.street}, ${o.city}<br/>${o.distance.toFixed(2)} km</div>`),k.setPopup(B)}),p.fitBounds(h,{padding:50,maxZoom:12}),t.status=`Found ${a.length} closest branches`}catch(e){console.error("Branch finding error:",e),t.status=`Error: ${e.message}`}}}}},R={class:"text-center q-mt-md"},T={style:{height:"50vh",width:"90vw","margin-left":"5vw",border:"solid"},ref:"mapRef"},_={key:0,class:"status q-mt-md text-subtitle2 text-negative"};function O(m,t,A,e,r,n){return P(),y("div",R,[t[2]||(t[2]=u("div",{class:"text-h4"},"Find 3 Closest Branches To:",-1)),u("div",null,[x(U,{class:"q-ma-lg text-h5",placeholder:"enter current address",id:"address",modelValue:e.state.address,"onUpdate:modelValue":t[0]||(t[0]=l=>e.state.address=l)},null,8,["modelValue"]),t[1]||(t[1]=u("br",null,null,-1))]),x($,{label:"FIND 3",onClick:e.findClosestBranches,class:"q-mb-md",style:{width:"30vw"}},null,8,["onClick"]),L(u("div",T,null,512),[[b,e.state.showmap===!0]]),e.state.status?(P(),y("div",_,j(e.state.status),1)):S("",!0)])}const Z=E(I,[["render",O]]);export{Z as default};
