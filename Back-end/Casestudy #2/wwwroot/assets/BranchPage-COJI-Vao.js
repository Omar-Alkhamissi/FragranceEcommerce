import{Q as B}from"./QInput-CiUyvvsP.js";import{Q as N}from"./QBtn-CEKbPtZc.js";import{O as w,q as p,x as h,t as g,v as x,P as _,ah as C,y as $,r as T,f as b,o as I,U as L}from"./index-CyKUSn2P.js";import{_ as S}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-key-composition-BqJDhFz5.js";import"./focus-manager-DL2ufsuZ.js";const E={name:"BranchPage",setup(){const d=T(null);let o=null;const s=b({address:"",status:"",showmap:!1}),r="zXKLKlV5oNoDXSFJUmQuGKA2081UKQ0P",f=t=>window.tt?(o&&(o.remove(),o=null),o=window.tt.map({key:r,container:d.value,center:t,zoom:11}),o&&window.tt&&typeof window.tt.NavigationControl=="function"&&o.addControl(new window.tt.NavigationControl),o):(s.status="TomTom SDK not loaded on page",null),c=(t,i,a)=>{try{const n=new window.tt.Marker().setLngLat([t,i]).addTo(o);if(a){const e=new window.tt.Popup({offset:25});e.setHTML(a),n.setPopup(e)}}catch(n){console.warn("marker error",n)}},l=async t=>{const i=`https://api.tomtom.com/search/2/geocode/${encodeURIComponent(t)}.json?key=${r}&countrySet=CA&typeahead=false&limit=1`,a=await fetch(i);if(!a.ok)throw new Error(`TomTom geocoding failed: ${a.status}`);const e=(await a.json()).results?.[0];if(!e)throw new Error("No results found for that address");return{lat:Number(e.position.lat),lon:Number(e.position.lon),freeform:e.address?.freeformAddress||t}},v=async(t,i)=>{const a=sessionStorage.getItem("token")||localStorage.getItem("token")||"",n=await fetch(`/api/Branch/${t}/${i}`,{headers:a?{Authorization:`Bearer ${a}`}:{}});if(!n.ok){const e=await n.text();throw new Error(`Branch API failed: ${n.status} - ${e}`)}return await n.json()},y=async()=>{if(s.status="",s.showmap=!1,!s.address?.trim()){s.status="Enter an address or postal code";return}try{const t=await l(s.address.trim());s.showmap=!0,await L();const i=f([t.lon,t.lat]);if(!i)return;c(t.lon,t.lat,`<div><b>You</b><br/>${t.freeform}</div>`);const a=await v(t.lat,t.lon);if(!a?.length){s.status="No branches returned";return}const n=new window.tt.LngLatBounds([t.lon,t.lat],[t.lon,t.lat]);a.forEach(e=>{const m=Number(e.longitude??e.Longitude),u=Number(e.latitude??e.Latitude),k=Number(e.distance??e.Distance??0);Number.isFinite(m)&&Number.isFinite(u)&&(c(m,u,`<div style="font-weight:600; margin-bottom:4px;">Branch #${e.id??e.Id}</div>
               <div>${e.street??e.Street??""}, ${e.city??e.City??""} ${e.region??e.Region??""}<br/>
               ${k.toFixed(2)} mi</div>`),n.extend([m,u]))}),i.fitBounds(n,{padding:60,duration:500}),s.status=""}catch(t){console.error(t),s.status=typeof t?.message=="string"?t.message:"Unexpected error"}};return I(()=>{o&&(o.remove(),o=null)}),{mapRef:d,state:s,findClosestBranches:y}}},P={class:"text-center q-mt-md"},U={ref:"mapRef",style:{height:"50vh",width:"90vw","margin-left":"5vw",border:"solid"}},V={key:0,class:"status q-mt-md text-subtitle2 text-negative"};function j(d,o,s,r,f,c){return p(),w("div",P,[o[1]||(o[1]=h("div",{class:"text-h4"},"Find 3 Closest Branches To:",-1)),g(B,{class:"q-ma-lg text-h5",placeholder:"enter current address or postal code",modelValue:r.state.address,"onUpdate:modelValue":o[0]||(o[0]=l=>r.state.address=l),id:"address"},null,8,["modelValue"]),g(N,{label:"FIND 3",onClick:r.findClosestBranches,class:"q-mb-md",style:{width:"30vw"}},null,8,["onClick"]),x(h("div",U,null,512),[[C,r.state.showmap===!0]]),r.state.status?(p(),w("div",V,$(r.state.status),1)):_("",!0)])}const q=S(E,[["render",j],["__scopeId","data-v-22f71c0f"]]);export{q as default};
