import{Q as C}from"./QInput-lgK-DkcS.js";import{Q as P}from"./QBtn-DDD1QPEz.js";import{O as T,q as v,x as m,t as A,v as k,P as x,ah as U,y as b,r as E,f as N}from"./index-gwHdcYLu.js";import{_ as $}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-key-composition-BN6q0Xrk.js";import"./focus-manager-BiIaYFhc.js";const L={name:"BranchePage",setup(){const u=E(null);let o=N({status:"",address:"T5A 0A3",showmap:!1});return{mapRef:u,state:o,findClosestBranches:async()=>{try{o.status="Finding branches...",o.showmap=!0;const t=window.tt;let r,a;try{console.log("Trying TomTom geocoding...");let e=o.address.trim();if(e.match(/^[A-Za-z]\d[A-Za-z][\s-]?\d[A-Za-z]\d$/)){let s=e.replace(/[-\s]/g,"");e=s.substring(0,3)+" "+s.substring(3)}let n=`https://api.tomtom.com/search/2/geocode/${encodeURIComponent(e)}.json?key=Hyxyimv7jPnUdwKFnzcAcAcjaUQEWPzB`;console.log("TomTom URL:",n);let l=await fetch(n);if(console.log("TomTom response status:",l.status),l.ok){let s=await l.json();if(console.log("TomTom payload:",s),s.results&&s.results.length>0)r=parseFloat(s.results[0].position.lat),a=parseFloat(s.results[0].position.lon),console.log("TomTom coordinates:",r,a);else throw new Error("No results from TomTom")}else throw new Error(`TomTom API error: ${l.status}`)}catch(e){console.log("TomTom failed, using fallback coordinates:",e.message);const n={"T5A 0A3":{lat:53.5461,lon:-113.4938},T5A0A3:{lat:53.5461,lon:-113.4938},"N5X 2C1":{lat:42.9849,lon:-81.2453},N5X2C1:{lat:42.9849,lon:-81.2453},"M5V 3A8":{lat:43.6426,lon:-79.3871},M5V3A8:{lat:43.6426,lon:-79.3871}};let l=o.address.replace(/[-\s]/g,"").toUpperCase(),s=o.address.replace(/[-]/g," ").toUpperCase();if(n[l])r=n[l].lat,a=n[l].lon,console.log("Using fallback coordinates:",r,a);else if(n[s])r=n[s].lat,a=n[s].lon,console.log("Using fallback coordinates:",r,a);else if(o.address.toUpperCase().startsWith("T5A"))r=53.5461,a=-113.4938,console.log("Using Edmonton default for T5A postal code");else throw new Error("Could not geocode address")}const p=JSON.parse(sessionStorage.getItem("customer")||"{}");if(!p.token){o.status="Please login first to find branches";return}console.log("Using coordinates:",r,a);let f=`/api/Branch/${r}/${a}`;console.log("Branch API URL:",f);let c=await fetch(f,{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+p.token}});if(console.log("Branch response status:",c.status),!c.ok){const e=await c.text();throw console.log("Branch API error response:",e),new Error(`Branch API error: ${c.status} - ${e}`)}let g=await c.text();console.log("Branch API response:",g);let d;try{d=JSON.parse(g)}catch(e){throw console.error("JSON parse error:",e),new Error(`Invalid JSON response: ${g}`)}if(console.log("Parsed branches:",d),!d||d.length===0){o.status="No branches found";return}let i=t.map({key:"Hyxyimv7jPnUdwKFnzcAcAcjaUQEWPzB",container:u.value,source:"vector/1/basic-main",center:[a,r],zoom:8});i.addControl(new t.FullscreenControl),i.addControl(new t.NavigationControl);const h=new t.LngLatBounds;let y=new t.Marker({color:"red"}).setLngLat([a,r]).addTo(i),w=new t.Popup({offset:25});w.setHTML(`<div>Search Location<br/>${o.address}</div>`),y.setPopup(w),h.extend([a,r]),d.forEach(e=>{h.extend([e.longitude,e.latitude]);let n=new t.Marker().setLngLat([e.longitude,e.latitude]).addTo(i),l=25,s=new t.Popup({offset:l});s.setHTML(`<div id="popup">Branch# ${e.id}</div><div>${e.street}, ${e.city}<br/>${e.distance.toFixed(2)} km</div>`),n.setPopup(s)}),i.fitBounds(h,{padding:50,maxZoom:12}),o.status=`Found ${d.length} closest branches`}catch(t){console.error("Branch finding error:",t),o.status=`Error: ${t.message}`}}}}},F={class:"text-center q-mt-md"},I={style:{height:"50vh",width:"90vw","margin-left":"5vw",border:"solid"},ref:"mapRef"},z={key:0,class:"status q-mt-md text-subtitle2 text-negative"};function S(u,o,B,t,r,a){return v(),T("div",F,[o[2]||(o[2]=m("div",{class:"text-h4"},"Find 3 Closest Branches To:",-1)),m("div",null,[A(C,{class:"q-ma-lg text-h5",placeholder:"enter current address",id:"address",modelValue:t.state.address,"onUpdate:modelValue":o[0]||(o[0]=p=>t.state.address=p)},null,8,["modelValue"]),o[1]||(o[1]=m("br",null,null,-1))]),A(P,{label:"FIND 3",onClick:t.findClosestBranches,class:"q-mb-md",style:{width:"30vw"}},null,8,["onClick"]),k(m("div",I,null,512),[[U,t.state.showmap===!0]]),t.state.status?(v(),T("div",z,b(t.state.status),1)):x("",!0)])}const Q=$(L,[["render",S]]);export{Q as default};
