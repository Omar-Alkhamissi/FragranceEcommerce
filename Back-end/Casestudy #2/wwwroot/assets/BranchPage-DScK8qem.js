import{Q as P}from"./QInput-DTeG9EGs.js";import{Q as M}from"./QBtn-vNJm-IMR.js";import{O as I,q as w,x as p,t as y,v as T,P as x,ah as F,y as S,r as L,f as D}from"./index-C_z8o39H.js";import{_ as O}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-key-composition-B382cZ_R.js";import"./focus-manager-Dq7SsGGe.js";const U={name:"BranchePage",setup(){const h=L(null);let o=D({status:"",address:"T5A-0A3",showmap:!1});const N=async()=>{try{console.log("=== BRANCH FINDER STARTED ==="),console.log(`Input address: "${o.address}"`),o.status="Finding branches...",o.showmap=!0;const t=window.tt;let a=o.address;if(o.address.match(/^[A-Za-z]\d[A-Za-z][\s-]?\d[A-Za-z]\d$/)){let e=o.address.replace(/[-\s]/g,""),s=e.substring(0,3)+" "+e.substring(3);a=`${s}, Canada`,console.log(`Postal code detected. Cleaned: "${e}" -> Formatted: "${s}"`)}console.log("=== GEOCODING STEP ==="),console.log(`Final search address: "${a}"`);let c=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&countrycodes=ca&limit=1`;console.log(`Geocoding URL: ${c}`);let u=await(await fetch(c)).json();if(console.log("Geocoding response:",u),!u||u.length===0){console.error("❌ Geocoding failed - no results"),o.status="Address not found";return}let n=parseFloat(u[0].lat),l=parseFloat(u[0].lon);console.log("✅ Geocoded successfully:"),console.log(`  - Latitude: ${n}`),console.log(`  - Longitude: ${l}`),console.log(`  - Display name: ${u[0].display_name}`);let g=`/api/Branch/${n}/${l}`;console.log("=== BRANCH API CALL ==="),console.log(`Branch API URL: ${g}`);let d=await fetch(g,{method:"GET",headers:{"Content-Type":"application/json",...R()}});if(console.log(`Branch API response status: ${d.status}`),!d.ok)throw console.error(`❌ Branch API failed: ${d.status} - ${d.statusText}`),new Error(`Branch API error: ${d.status} - ${d.statusText}`);let f=await d.text();console.log("Raw branch API response:",f);let i;try{i=JSON.parse(f)}catch(e){throw console.error("❌ JSON parse error:",e),new Error(`Invalid JSON response: ${f}`)}if(!i||i.length===0){console.error("❌ No branches returned from API"),o.status="No branches found";return}console.log("=== BRANCH RESULTS ==="),console.log(`Total branches returned: ${i.length}`),i.forEach((e,s)=>{console.log(`Branch ${s+1}:`),console.log(`  - ID: ${e.id}`),console.log(`  - Street: ${e.street}`),console.log(`  - City: ${e.city}`),console.log(`  - Latitude: ${e.latitude}`),console.log(`  - Longitude: ${e.longitude}`),console.log(`  - Distance: ${e.distance} km`);const m=r(n,l,e.latitude,e.longitude);console.log(`  - Calculated distance from search: ${m.toFixed(2)} km`)}),console.log("=== MAP CREATION ==="),console.log(`Map center coordinates: [${l}, ${n}]`),console.log("Map zoom level: 10");let $=t.map({key:"Hyxyimv7jPnUdwKFnzcAcAcjaUQEWPzB",container:h.value,source:"vector/1/basic-main",center:[l,n],zoom:10});$.addControl(new t.FullscreenControl),$.addControl(new t.NavigationControl),console.log("=== MARKER CREATION ==="),i.forEach((e,s)=>{if(console.log(`Creating marker ${s+1}:`),console.log(`  - Branch: ${e.street}, ${e.city}`),console.log(`  - Coordinates: [${e.longitude}, ${e.latitude}]`),isNaN(e.longitude)||isNaN(e.latitude)){console.error(`❌ Invalid coordinates for branch ${e.id}!`);return}try{let m=new t.Marker().setLngLat([e.longitude,e.latitude]).addTo($);console.log(`✅ Marker ${s+1} created successfully at [${e.longitude}, ${e.latitude}]`);let k=25,E=new t.Popup({offset:k});E.setHTML(`<div id="popup">Branch# ${e.id}</div><div>${e.street}, ${e.city}<br/>${e.distance.toFixed(2)} km</div>`),m.setPopup(E),console.log(`✅ Popup added to marker ${s+1}`)}catch(m){console.error(`❌ Error creating marker ${s+1}:`,m)}});const C=i.map(e=>r(n,l,e.latitude,e.longitude)),A=Math.max(...C),B=C.reduce((e,s)=>e+s,0)/C.length;console.log("=== DISTANCE ANALYSIS ==="),console.log(`Max distance from search: ${A.toFixed(2)} km`),console.log(`Average distance from search: ${B.toFixed(2)} km`),A>100&&(console.log(`⚠️ WARNING: Branches are very far from search location (${A.toFixed(2)} km)`),console.log("This suggests the stored procedure is returning branches from a different region")),o.status=`Found ${i.length} closest branches`,console.log("=== BRANCH FINDER COMPLETED SUCCESSFULLY ===")}catch(t){console.error("=== BRANCH FINDER ERROR ==="),console.error("Error details:",t),console.error("Error stack:",t.stack),o.status=`Error: ${t.message}`}},r=(t,a,c,v)=>{const n=(c-t)*Math.PI/180,l=(v-a)*Math.PI/180,g=Math.sin(n/2)*Math.sin(n/2)+Math.cos(t*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(l/2)*Math.sin(l/2);return 6371*(2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g)))},R=()=>{const t=new Headers;t.append("Content-Type","application/json");const a=sessionStorage.getItem("customer");if(a)try{const c=JSON.parse(a);c?.token&&t.append("Authorization","Bearer "+c.token)}catch{}return t};return{mapRef:h,state:o,findClosestBranches:N}}},H={class:"text-center q-mt-md"},_={style:{height:"50vh",width:"90vw","margin-left":"5vw",border:"solid"},ref:"mapRef"},q={key:0,class:"status q-mt-md text-subtitle2 text-negative"};function z(h,o,N,r,R,t){return w(),I("div",H,[o[2]||(o[2]=p("div",{class:"text-h4"},"Find 3 Closest Branches To:",-1)),p("div",null,[y(P,{class:"q-ma-lg text-h5",placeholder:"enter current address",id:"address",modelValue:r.state.address,"onUpdate:modelValue":o[0]||(o[0]=a=>r.state.address=a)},null,8,["modelValue"]),o[1]||(o[1]=p("br",null,null,-1))]),y(M,{label:"FIND 3",onClick:r.findClosestBranches,class:"q-mb-md",style:{width:"30vw"}},null,8,["onClick"]),T(p("div",_,null,512),[[F,r.state.showmap===!0]]),r.state.status?(w(),I("div",q,S(r.state.status),1)):x("",!0)])}const K=O(U,[["render",z]]);export{K as default};
