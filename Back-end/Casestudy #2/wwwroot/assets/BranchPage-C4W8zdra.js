import{Q as N}from"./QInput-BVWJ-gvT.js";import{Q as x}from"./QBtn-DFHQSpZo.js";import{O as p,q as w,x as h,t as g,v as _,P as $,ah as C,y as S,r as T,f as b,o as I,U as j}from"./index-DTVbgBqf.js";import{_ as L}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-key-composition-DMU7ijHq.js";import"./focus-manager-C01IsISJ.js";const A={name:"BranchPage",setup(){const c=T(null);let s=null;const n=b({address:"T5A 0A3",status:"",showmap:!1}),d="zXKLKlV5oNoDXSFJUmQuGKA2081UKQ0P",f=t=>window.tt?(s&&(s.remove(),s=null),s=window.tt.map({key:d,container:c.value,center:t,zoom:11}),s&&window.tt&&typeof window.tt.NavigationControl=="function"&&s.addControl(new window.tt.NavigationControl),s):(n.status="TomTom SDK not loaded on page",null),l=(t,a,o)=>{const r=new window.tt.Marker().setLngLat([t,a]).addTo(s);if(o){const e=new window.tt.Popup({offset:25});e.setHTML(o),r.setPopup(e)}},u=async t=>{const a=`https://api.tomtom.com/search/2/geocode/${encodeURIComponent(t)}.json?key=${d}&countrySet=CA&typeahead=false&limit=1`,o=await fetch(a);if(!o.ok){const i=await o.text();throw new Error(`TomTom geocoding failed: ${o.status} - ${i}`)}const e=(await o.json()).results?.[0];if(!e)throw new Error("No results found for that address");return{lat:Number(e.position.lat),lon:Number(e.position.lon),freeform:e.address?.freeformAddress||t}},v=()=>{const t=sessionStorage.getItem("token")||localStorage.getItem("token");if(t)return t.replace(/^"|"$/g,"");for(const a of[sessionStorage,localStorage])for(let o=0;o<a.length;o++){const r=a.key(o),e=a.getItem(r);if(e)try{const i=JSON.parse(e);if(i&&typeof i=="object"&&typeof i.token=="string")return i.token}catch{continue}}return""},k=async(t,a)=>{const o=v(),r=await fetch(`/api/Branch/${t}/${a}`,{headers:o?{Authorization:`Bearer ${o}`}:{}});if(!r.ok){const e=await r.text();throw new Error(`Branch API failed: ${r.status} - ${e}`)}return await r.json()},y=async()=>{if(n.status="",n.showmap=!1,!n.address?.trim()){n.status="Enter an address or postal code";return}try{const t=await u(n.address.trim());n.showmap=!0,await j();const a=f([t.lon,t.lat]);if(!a)return;l(t.lon,t.lat,`<div><b>You</b><br/>${t.freeform}</div>`);const o=await k(t.lat,t.lon);if(!o?.length){n.status="No branches returned";return}const r=new window.tt.LngLatBounds([t.lon,t.lat],[t.lon,t.lat]);o.forEach(e=>{const i=Number(e.longitude??e.Longitude),m=Number(e.latitude??e.Latitude),B=Number(e.distance??e.Distance??0);Number.isFinite(i)&&Number.isFinite(m)&&(l(i,m,`<div id="popup">Branch #${e.id??e.Id}</div>
               <div>${e.street??e.Street??""}, ${e.city??e.City??""} ${e.region??e.Region??""}<br/>
               ${B.toFixed(2)} mi</div>`),r.extend([i,m]))}),a.fitBounds(r,{padding:60,duration:500}),n.status=""}catch(t){console.error(t),n.status=typeof t?.message=="string"?t.message:"Unexpected error"}};return I(()=>{s&&(s.remove(),s=null)}),{mapRef:c,state:n,findClosestBranches:y}}},E={class:"text-center q-mt-md"},P={ref:"mapRef",style:{height:"50vh",width:"90vw","margin-left":"5vw",border:"solid"}},U={key:0,class:"status q-mt-md text-subtitle2 text-negative"};function V(c,s,n,d,f,l){return w(),p("div",E,[s[1]||(s[1]=h("div",{class:"text-h4"},"Find 3 Closest Branches To:",-1)),g(N,{class:"q-ma-lg text-h5",placeholder:"enter current address or postal code",modelValue:d.state.address,"onUpdate:modelValue":s[0]||(s[0]=u=>d.state.address=u),id:"address"},null,8,["modelValue"]),g(x,{label:"FIND 3",onClick:d.findClosestBranches,class:"q-mb-md",style:{width:"30vw"}},null,8,["onClick"]),_(h("div",P,null,512),[[C,d.state.showmap===!0]]),d.state.status?(w(),p("div",U,S(d.state.status),1)):$("",!0)])}const q=L(A,[["render",V],["__scopeId","data-v-1e43eba3"]]);export{q as default};
