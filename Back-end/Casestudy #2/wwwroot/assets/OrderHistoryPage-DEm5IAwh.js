import{Q as b}from"./QBtn-BQ37nqm7.js";import{Q as _}from"./QCardSection-BR4Er-4I.js";import{Q as C}from"./QSeparator-Mz6QJkgF.js";import{Q as N}from"./QCard-usVoljUo.js";import{Q as T}from"./QDialog-CjqX4FCW.js";import{_ as O}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{O as f,q as u,x as t,P as q,t as d,y as n,Q as D,R as k,s as h,u as L,f as Q,z as v}from"./index-CV4FAOBx.js";import"./focus-manager-BLyGvPrO.js";import"./focusout-D7ChthLl.js";const B={name:"OrderHistoryPage",setup(){const o=Q({email:"",orders:[],details:[],selected:null,selectedLocalTime:"",showDetails:!1,error:""}),i=()=>{for(const e of[sessionStorage,localStorage])for(let a=0;a<e.length;a++){const c=e.key(a),m=e.getItem(c);if(m)try{const l=JSON.parse(m);if(l&&typeof l=="object"&&(!o.email&&typeof l.email=="string"&&(o.email=l.email),typeof l.token=="string"))return l.token}catch{}}return""},g=()=>{const e=sessionStorage.getItem("token")||localStorage.getItem("token");return e?e.replace(/^"|"$/g,""):i()},r=e=>Number(e).toLocaleString("en-US",{style:"currency",currency:"USD"}),x=e=>{const a=e instanceof Date?e:new Date(e);return Number.isNaN(a.getTime())?String(e):new Intl.DateTimeFormat(void 0,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!0}).format(a)},y=e=>{const a=e instanceof Date?e:new Date(e);return Number.isNaN(a.getTime())?String(e):a.toLocaleDateString()},s=e=>e.reduce((a,c)=>a+Number(c.sellingPrice)*Number(c.qtyOrdered),0),w=e=>Math.round(s(e)*.13*100)/100,S=async()=>{o.error="";const e=g();if(!o.email){o.error="Unable to determine logged-in user.";return}const a=await fetch(`/api/Order/${encodeURIComponent(o.email)}`,{headers:e?{Authorization:`Bearer ${e}`}:{}});if(!a.ok){o.error=`Failed to load orders: ${a.status}`;return}o.orders=await a.json()},p=async e=>{o.selected=e,o.details=[],o.selectedLocalTime="";const a=g(),c=`/api/Order/${e.id}/${encodeURIComponent(o.email)}`,m=await fetch(c,{headers:a?{Authorization:`Bearer ${a}`}:{}});if(!m.ok){o.error=`Failed to load order ${e.id}: ${m.status}`;return}const l=await m.json();o.details=l,l&&l.length>0&&l[0].dateCreated&&(o.selectedLocalTime=x(l[0].dateCreated)),o.showDetails=!0};return v(S),{state:o,formatCurrency:r,formatLocalDate:y,calcSubTotal:s,calcTax:w,openDetails:p}}},I={class:"q-pa-md"},V={key:0,class:"text-negative text-subtitle2 q-mb-sm"},j={class:"q-table full-width"},U={class:"text-left"},A={class:"text-left"},P={class:"text-right"},z={class:"text-right"},F={class:"text-h6"},H={class:"q-table full-width"},R={class:"text-left"},E={class:"text-center"},J={class:"text-center"},M={class:"text-center"},G={class:"text-right"},K={class:"q-mt-md"},W={class:"row justify-end"},X={class:"col-auto"},Y={class:"text-weight-bold"};function Z(o,i,g,r,x,y){return u(),f("div",I,[i[4]||(i[4]=t("div",{class:"text-h4 text-center q-mb-md"},"Order History",-1)),r.state.error?(u(),f("div",V,n(r.state.error),1)):q("",!0),t("table",j,[i[2]||(i[2]=t("thead",null,[t("tr",null,[t("th",{class:"text-left"},"#"),t("th",{class:"text-left"},"Date"),t("th",{class:"text-right"},"Total"),t("th",{class:"text-right"},"Action")])],-1)),t("tbody",null,[(u(!0),f(D,null,k(r.state.orders,s=>(u(),f("tr",{key:s.id},[t("td",U,n(s.id),1),t("td",A,n(r.formatLocalDate(s.orderDate)),1),t("td",P,n(r.formatCurrency(s.orderAmount||0)),1),t("td",z,[d(b,{size:"sm",color:"primary",label:"View",onClick:w=>r.openDetails(s)},null,8,["onClick"])])]))),128))])]),d(T,{modelValue:r.state.showDetails,"onUpdate:modelValue":i[1]||(i[1]=s=>r.state.showDetails=s),persistent:""},{default:h(()=>[d(N,{style:{"max-width":"380px",width:"92vw"}},{default:h(()=>[d(_,{class:"row items-center justify-between"},{default:h(()=>[t("div",F,"Order #"+n(r.state.selected?.id),1),d(b,{dense:"",flat:"",round:"",icon:"close",onClick:i[0]||(i[0]=s=>r.state.showDetails=!1)})]),_:1}),d(_,{class:"text-subtitle2"},{default:h(()=>[L(n(r.state.selectedLocalTime),1)]),_:1}),d(C),d(_,null,{default:h(()=>[t("table",H,[i[3]||(i[3]=t("thead",null,[t("tr",null,[t("th",{class:"text-left"},"Name"),t("th",{class:"text-center"},"S"),t("th",{class:"text-center"},"O"),t("th",{class:"text-center"},"B"),t("th",{class:"text-right"},"Extended")])],-1)),t("tbody",null,[(u(!0),f(D,null,k(r.state.details,s=>(u(),f("tr",{key:s.productId},[t("td",R,n(s.productName),1),t("td",E,n(s.qtySold),1),t("td",J,n(s.qtyOrdered),1),t("td",M,n(s.qtyBackOrdered),1),t("td",G,n(r.formatCurrency(s.sellingPrice*s.qtyOrdered)),1)]))),128))])]),t("div",K,[t("div",W,[t("div",X,[t("div",null,"Sub: "+n(r.formatCurrency(r.calcSubTotal(r.state.details))),1),t("div",null,"Tax(13%): "+n(r.formatCurrency(r.calcTax(r.state.details))),1),t("div",Y,"Total: "+n(r.formatCurrency(r.state.selected?.orderAmount||0)),1)])])])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}const lt=O(B,[["render",Z],["__scopeId","data-v-7ca2d2e3"]]);export{lt as default};
