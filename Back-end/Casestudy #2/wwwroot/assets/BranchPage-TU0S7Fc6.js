import{Q as k}from"./QInput-LK9RBCct.js";import{Q as y}from"./QBtn-CCl3ETPk.js";import{O as m,q as f,x as p,t as w,v as _,P as x,ah as $,y as C,r as h,f as N,o as T}from"./index-CBEMdLdY.js";import{_ as E}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-key-composition-C9E86gwL.js";import"./focus-manager-Beo8uyHd.js";const P={name:"BranchPage",setup(){const i=h(null),o=h(null),n=N({address:"",status:"",showmap:!1}),r="zXKLKlV5oNoDXSFJUmQuGKA2081UKQ0P",u=t=>window.tt?(o.value&&(o.value.remove(),o.value=null),o.value=window.tt.map({key:r,container:i.value,center:t,zoom:11}),o.value.addControl(new window.tt.NavigationControl),o.value):(n.status="TomTom SDK not loaded on page",null),l=(t,d,s)=>{const a=new window.tt.Marker().setLngLat([t,d]).addTo(o.value);if(s){const e=new window.tt.Popup({offset:25});e.setHTML(s),a.setPopup(e)}return a},c=async t=>{const d=`https://api.tomtom.com/search/2/geocode/${encodeURIComponent(t)}.json?key=${r}&countrySet=CA&typeahead=false&limit=1`,s=await fetch(d);if(!s.ok){const B=await s.text();throw new Error(`TomTom geocoding failed: ${s.status} - ${B}`)}const a=await s.json(),e=a.results&&a.results[0];if(!e)throw new Error("No results found for that address");return{lat:e.position.lat,lon:e.position.lon,freeform:e.address?.freeformAddress||t}},v=async(t,d)=>{const s=localStorage.getItem("token"),a=await fetch(`/api/Branch/${t}/${d}`,{headers:s?{Authorization:`Bearer ${s}`}:{}});if(!a.ok){const e=await a.text();throw new Error(`Branch API failed: ${a.status} - ${e}`)}return await a.json()},g=async()=>{if(n.status="",n.showmap=!1,!n.address?.trim()){n.status="Enter an address or postal code";return}try{const t=await c(n.address.trim());n.showmap=!0;const d=u([t.lon,t.lat]);if(!d)return;l(t.lon,t.lat,`<div><b>You</b><br/>${t.freeform}</div>`);const s=await v(t.lat,t.lon);if(!s?.length){n.status="No branches returned";return}const a=new window.tt.LngLatBounds([t.lon,t.lat],[t.lon,t.lat]);s.forEach(e=>{typeof e.longitude=="number"&&typeof e.latitude=="number"&&(l(e.longitude,e.latitude,`<div id="popup">Branch #${e.id}</div>
               <div>${e.street||""}, ${e.city||""} ${e.region||""}<br/>
               ${Number(e.distance||0).toFixed(2)} mi</div>`),a.extend([e.longitude,e.latitude]))}),d.fitBounds(a,{padding:60,duration:500})}catch(t){console.error(t),n.status=t.message}};return T(()=>{o.value&&(o.value.remove(),o.value=null)}),{mapRef:i,state:n,findClosestBranches:g}}},V={class:"text-center q-mt-md"},b={ref:"mapRef",style:{height:"50vh",width:"90vw","margin-left":"5vw",border:"solid"}},I={key:0,class:"status q-mt-md text-subtitle2 text-negative"};function K(i,o,n,r,u,l){return f(),m("div",V,[o[1]||(o[1]=p("div",{class:"text-h4"},"Find 3 Closest Branches To:",-1)),w(k,{class:"q-ma-lg text-h5",placeholder:"enter current address or postal code",modelValue:r.state.address,"onUpdate:modelValue":o[0]||(o[0]=c=>r.state.address=c),id:"address"},null,8,["modelValue"]),w(y,{label:"FIND 3",onClick:r.findClosestBranches,class:"q-mb-md",style:{width:"30vw"}},null,8,["onClick"]),_(p("div",b,null,512),[[$,r.state.showmap===!0]]),r.state.status?(f(),m("div",I,C(r.state.status),1)):x("",!0)])}const D=E(P,[["render",K],["__scopeId","data-v-9264e6df"]]);export{D as default};
