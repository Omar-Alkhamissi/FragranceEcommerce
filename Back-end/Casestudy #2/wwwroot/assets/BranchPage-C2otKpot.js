import{Q as E}from"./QInput-PaG20mcs.js";import{Q as $}from"./QBtn-DblFZyZg.js";import{O as B,q as y,x as u,t as C,v as b,P as L,ah as N,y as F,r as I,f as z}from"./index-D49DVX4m.js";import{_ as S}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-key-composition-B6YHrlxL.js";import"./focus-manager-DSSnuvNW.js";const _={name:"BranchePage",setup(){const f=I(null);let o=z({status:"",address:"T5A 0A3",showmap:!1});return{mapRef:f,state:o,findClosestBranches:async()=>{try{o.status="Finding branches...",o.showmap=!0;const t=window.tt;let a,n;try{console.log("Trying TomTom geocoding...");let s=o.address.trim();if(s.match(/^[A-Za-z]\d[A-Za-z][\s-]?\d[A-Za-z]\d$/)){let r=s.replace(/[-\s]/g,"");s=r.substring(0,3)+" "+r.substring(3)}let e=`https://api.tomtom.com/search/2/geocode/${encodeURIComponent(s)}.json?key=Hyxyimv7jPnUdwKFnzcAcAcjaUQEWPzB`;console.log("TomTom URL:",e);let l=await fetch(e);if(console.log("TomTom response status:",l.status),l.ok){let r=await l.json();if(console.log("TomTom payload:",r),r.results&&r.results.length>0)a=parseFloat(r.results[0].position.lat),n=parseFloat(r.results[0].position.lon),console.log("TomTom coordinates:",a,n);else throw new Error("No results from TomTom")}else throw new Error(`TomTom API error: ${l.status}`)}catch(s){console.log("TomTom failed, using fallback coordinates:",s.message);const e={"T5A 0A3":{lat:53.5461,lon:-113.4938},T5A0A3:{lat:53.5461,lon:-113.4938},"N5X 2C1":{lat:42.9849,lon:-81.2453},N5X2C1:{lat:42.9849,lon:-81.2453},"M5V 3A8":{lat:43.6426,lon:-79.3871},M5V3A8:{lat:43.6426,lon:-79.3871}};let l=o.address.replace(/[-\s]/g,"").toUpperCase(),r=o.address.replace(/[-]/g," ").toUpperCase();if(e[l])a=e[l].lat,n=e[l].lon,console.log("Using fallback coordinates:",a,n);else if(e[r])a=e[r].lat,n=e[r].lon,console.log("Using fallback coordinates:",a,n);else if(o.address.toUpperCase().startsWith("T5A"))a=53.5461,n=-113.4938,console.log("Using Edmonton default for T5A postal code");else throw new Error("Could not geocode address")}const m=JSON.parse(sessionStorage.getItem("customer")||"{}");if(!m.token){o.status="Please login first to find branches";return}console.log("Using coordinates:",a,n);let T=`/api/Branch/${a}/${n}`;console.log("Branch API URL:",T);let d=await fetch(T,{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+m.token}});if(console.log("Branch response status:",d.status),!d.ok){const s=await d.text();throw console.log("Branch API error response:",s),new Error(`Branch API error: ${d.status} - ${s}`)}let h=await d.text();console.log("Branch API response:",h);let c;try{c=JSON.parse(h)}catch(s){throw console.error("JSON parse error:",s),new Error(`Invalid JSON response: ${h}`)}if(console.log("Parsed branches:",c),!c||c.length===0){o.status="No branches found";return}let i=t.map({key:"Hyxyimv7jPnUdwKFnzcAcAcjaUQEWPzB",container:f.value,source:"vector/1/basic-main",center:[n,a],zoom:8});i.addControl(new t.FullscreenControl),i.addControl(new t.NavigationControl);const g=new t.LngLatBounds;let k=new t.Marker({color:"red"}).setLngLat([n,a]).addTo(i),v=new t.Popup({offset:25});v.setHTML(`<div>Search Location<br/>${o.address}</div>`),k.setPopup(v),g.extend([n,a]);const p={};c.forEach(s=>{const e=`${s.latitude},${s.longitude}`;p[e]||(p[e]=[]),p[e].push(s)}),Object.values(p).forEach(s=>{s.forEach((e,l)=>{let r=e.latitude,w=e.longitude;s.length>1&&(r+=l*5e-4,w+=l*5e-4),g.extend([w,r]);let x=new t.Marker().setLngLat([w,r]).addTo(i),U=25,A=new t.Popup({offset:U});A.setHTML(`<div id="popup">Branch# ${e.id}</div><div>${e.street}, ${e.city}<br/>${e.distance.toFixed(2)} km</div>`),x.setPopup(A)})}),i.fitBounds(g,{padding:50,maxZoom:12}),o.status=`Found ${c.length} closest branches`}catch(t){console.error("Branch finding error:",t),o.status=`Error: ${t.message}`}}}}},j={class:"text-center q-mt-md"},V={style:{height:"50vh",width:"90vw","margin-left":"5vw",border:"solid"},ref:"mapRef"},M={key:0,class:"status q-mt-md text-subtitle2 text-negative"};function O(f,o,P,t,a,n){return y(),B("div",j,[o[2]||(o[2]=u("div",{class:"text-h4"},"Find 3 Closest Branches To:",-1)),u("div",null,[C(E,{class:"q-ma-lg text-h5",placeholder:"enter current address",id:"address",modelValue:t.state.address,"onUpdate:modelValue":o[0]||(o[0]=m=>t.state.address=m)},null,8,["modelValue"]),o[1]||(o[1]=u("br",null,null,-1))]),C($,{label:"FIND 3",onClick:t.findClosestBranches,class:"q-mb-md",style:{width:"30vw"}},null,8,["onClick"]),b(u("div",V,null,512),[[N,t.state.showmap===!0]]),t.state.status?(y(),B("div",M,F(t.state.status),1)):L("",!0)])}const Z=S(_,[["render",O]]);export{Z as default};
