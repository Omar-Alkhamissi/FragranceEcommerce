import{Q as y}from"./QInput-BSI9Fmht.js";import{Q as k}from"./QBtn-DizMrovn.js";import{O as m,q as f,x as p,t as w,v as x,P as _,ah as $,y as C,r as h,f as T,o as b}from"./index-BrdEGh_s.js";import{_ as E}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-key-composition-zW78DiRz.js";import"./focus-manager-DRzJl3TG.js";const N={name:"BranchPage",setup(){const i=h(null),o=h(null),n=T({address:"",status:"",showmap:!1}),r="Hyxyimv7jPnUdwKFnzcAcAcjaUQEWPzB",u=t=>window.tt?(o.value&&(o.value.remove(),o.value=null),o.value=window.tt.map({key:r,container:i.value,center:t,zoom:11}),o.value.addControl(new window.tt.NavigationControl),o.value):(n.status="TomTom SDK not loaded on page",null),l=(t,d,a)=>{const s=new window.tt.Marker().setLngLat([t,d]).addTo(o.value);if(a){const e=new window.tt.Popup({offset:25});e.setHTML(a),s.setPopup(e)}return s},c=async t=>{const d=`https://api.tomtom.com/search/2/geocode/${encodeURIComponent(t)}.json?key=${r}&countrySet=CA&typeahead=false&limit=1`,a=await fetch(d);if(!a.ok){const B=await a.text();throw new Error(`TomTom geocoding failed: ${a.status} - ${B}`)}const s=await a.json(),e=s.results&&s.results[0];if(!e)throw new Error("No results found for that address");return{lat:e.position.lat,lon:e.position.lon,freeform:e.address?.freeformAddress||t}},v=async(t,d)=>{const a=localStorage.getItem("token"),s=await fetch(`/api/Branch/${t}/${d}`,{headers:a?{Authorization:`Bearer ${a}`}:{}});if(!s.ok){const e=await s.text();throw new Error(`Branch API failed: ${s.status} - ${e}`)}return await s.json()},g=async()=>{if(n.status="",n.showmap=!1,!n.address?.trim()){n.status="Enter an address or postal code";return}try{const t=await c(n.address.trim());n.showmap=!0;const d=u([t.lon,t.lat]);if(!d)return;l(t.lon,t.lat,`<div><b>You</b><br/>${t.freeform}</div>`);const a=await v(t.lat,t.lon);if(!a?.length){n.status="No branches returned";return}const s=new window.tt.LngLatBounds([t.lon,t.lat],[t.lon,t.lat]);a.forEach(e=>{typeof e.longitude=="number"&&typeof e.latitude=="number"&&(l(e.longitude,e.latitude,`<div id="popup">Branch #${e.id}</div>
               <div>${e.street||""}, ${e.city||""} ${e.region||""}<br/>
               ${Number(e.distance||0).toFixed(2)} mi</div>`),s.extend([e.longitude,e.latitude]))}),d.fitBounds(s,{padding:60,duration:500})}catch(t){console.error(t),n.status=t.message}};return b(()=>{o.value&&(o.value.remove(),o.value=null)}),{mapRef:i,state:n,findClosestBranches:g}}},P={class:"text-center q-mt-md"},j={ref:"mapRef",style:{height:"50vh",width:"90vw","margin-left":"5vw",border:"solid"}},A={key:0,class:"status q-mt-md text-subtitle2 text-negative"};function I(i,o,n,r,u,l){return f(),m("div",P,[o[1]||(o[1]=p("div",{class:"text-h4"},"Find 3 Closest Branches To:",-1)),w(y,{class:"q-ma-lg text-h5",placeholder:"enter current address or postal code",modelValue:r.state.address,"onUpdate:modelValue":o[0]||(o[0]=c=>r.state.address=c),id:"address"},null,8,["modelValue"]),w(k,{label:"FIND 3",onClick:r.findClosestBranches,class:"q-mb-md",style:{width:"30vw"}},null,8,["onClick"]),x(p("div",j,null,512),[[$,r.state.showmap===!0]]),r.state.status?(f(),m("div",A,C(r.state.status),1)):_("",!0)])}const q=E(N,[["render",I],["__scopeId","data-v-7b3cbf07"]]);export{q as default};
