import{Q as $}from"./QInput-XcGYTzKY.js";import{Q as N}from"./QBtn-CGF2qPiw.js";import{O as y,q as B,x as c,t as C,v as b,P as A,ah as F,y as P,r as _,f as E}from"./index-DzIjCz_L.js";import{_ as S}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-key-composition-sDJ5HJhL.js";import"./focus-manager-YWSwDM0b.js";const T={name:"BranchePage",setup(){const p=_(null);let e=E({status:"",address:"N5Y 5R6",showmap:!1});const m=async()=>{try{e.status="Finding branches...",e.showmap=!0;const t=window.tt;let o=e.address;if(e.address.match(/^[A-Za-z]\d[A-Za-z][\s-]?\d[A-Za-z]\d$/)){let s=e.address.replace(/[-\s]/g,"");o=`${s.substring(0,3)+" "+s.substring(3)}, Canada`}let r=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(o)}&countrycodes=ca&limit=1`,d=await(await fetch(r)).json();if(!d||d.length===0){e.status="Address not found";return}let u=parseFloat(d[0].lat),h=parseFloat(d[0].lon),x=`/api/Branch/${u}/${h}`,l=await fetch(x,{method:"GET",headers:{"Content-Type":"application/json",...a()}});if(!l.ok)throw new Error(`Branch API error: ${l.status} - ${l.statusText}`);let f=await l.text(),n;try{n=JSON.parse(f)}catch(s){throw console.error("JSON parse error:",s),new Error(`Invalid JSON response: ${f}`)}if(!n||n.length===0){e.status="No branches found";return}let i=t.map({key:"Hyxyimv7jPnUdwKFnzcAcAcjaUQEWPzB",container:p.value,source:"vector/1/basic-main",center:[h,u],zoom:8});i.addControl(new t.FullscreenControl),i.addControl(new t.NavigationControl);const g=new t.LngLatBounds;n.forEach(s=>{g.extend([s.longitude,s.latitude]);let w=new t.Marker().setLngLat([s.longitude,s.latitude]).addTo(i),k=25,v=new t.Popup({offset:k});v.setHTML(`<div id="popup">Branch# ${s.id}</div><div>${s.street}, ${s.city}<br/>${s.distance.toFixed(2)} km</div>`),w.setPopup(v)}),i.fitBounds(g,{padding:50,maxZoom:12}),e.status=`Found ${n.length} closest branches`}catch(t){console.error("Branch finding error:",t),e.status=`Error: ${t.message}`}},a=()=>{const t=new Headers;t.append("Content-Type","application/json");const o=sessionStorage.getItem("customer");if(o)try{const r=JSON.parse(o);r?.token&&t.append("Authorization","Bearer "+r.token)}catch{}return t};return{mapRef:p,state:e,findClosestBranches:m}}},z={class:"text-center q-mt-md"},R={style:{height:"50vh",width:"90vw","margin-left":"5vw",border:"solid"},ref:"mapRef"},j={key:0,class:"status q-mt-md text-subtitle2 text-negative"};function q(p,e,m,a,t,o){return B(),y("div",z,[e[2]||(e[2]=c("div",{class:"text-h4"},"Find 3 Closest Branches To:",-1)),c("div",null,[C($,{class:"q-ma-lg text-h5",placeholder:"enter current address",id:"address",modelValue:a.state.address,"onUpdate:modelValue":e[0]||(e[0]=r=>a.state.address=r)},null,8,["modelValue"]),e[1]||(e[1]=c("br",null,null,-1))]),C(N,{label:"FIND 3",onClick:a.findClosestBranches,class:"q-mb-md",style:{width:"30vw"}},null,8,["onClick"]),b(c("div",R,null,512),[[F,a.state.showmap===!0]]),a.state.status?(B(),y("div",j,P(a.state.status),1)):A("",!0)])}const J=S(T,[["render",q]]);export{J as default};
