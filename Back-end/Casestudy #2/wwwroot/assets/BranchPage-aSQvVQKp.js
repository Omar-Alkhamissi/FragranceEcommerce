import{Q as N}from"./QInput-CjZEpSkc.js";import{Q as x}from"./QBtn-fhb5mI2w.js";import{O as p,q as w,x as h,t as g,v as _,P as $,af as C,y as T,r as S,f as I,o as j,U as L}from"./index-Cd5M0Izq.js";import{_ as A}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-key-composition-Biot7_H7.js";import"./focus-manager-V_t-QWar.js";const E={name:"BranchPage",setup(){const l=S(null);let s=null;const r=I({address:"T5A 0A3",status:"",showmap:!1}),d="zXKLKlV5oNoDXSFJUmQuGKA2081UKQ0P",m=e=>window.tt?(s&&(s.remove(),s=null),s=window.tt.map({key:d,container:l.value,center:e,zoom:11}),s&&window.tt&&typeof window.tt.NavigationControl=="function"&&s.addControl(new window.tt.NavigationControl),s):(r.status="TomTom SDK not loaded on page",null),f=(e,a,o)=>{const n=new window.tt.Marker().setLngLat([e,a]).addTo(s);if(o){const t=new window.tt.Popup({offset:25});t.setHTML(o),n.setPopup(t)}},u=async e=>{const a=`https://api.tomtom.com/search/2/geocode/${encodeURIComponent(e)}.json?key=${d}&countrySet=CA&typeahead=false&limit=1`,o=await fetch(a);if(!o.ok){const i=await o.text();throw new Error(`TomTom geocoding failed: ${o.status} - ${i}`)}const t=(await o.json()).results?.[0];if(!t)throw new Error("No results found for that address");return{lat:Number(t.position.lat),lon:Number(t.position.lon),freeform:t.address?.freeformAddress||e}},v=()=>{const e=sessionStorage.getItem("token")||localStorage.getItem("token");if(e)return e.replace(/^"|"$/g,"");for(const a of[sessionStorage,localStorage])for(let o=0;o<a.length;o++){const n=a.key(o),t=a.getItem(n);if(t)try{const i=JSON.parse(t);if(i&&typeof i=="object"&&typeof i.token=="string")return i.token}catch{continue}}return""},k=async(e,a)=>{const o=v(),n=await fetch(`/api/Branch/${e}/${a}`,{headers:o?{Authorization:`Bearer ${o}`}:{}});if(!n.ok){const t=await n.text();throw new Error(`Branch API failed: ${n.status} - ${t}`)}return await n.json()},y=async()=>{if(r.status="",r.showmap=!1,!r.address?.trim()){r.status="Enter an address or postal code";return}try{const e=await u(r.address.trim());r.showmap=!0,await L();const a=m([e.lon,e.lat]);if(!a)return;const o=await k(e.lat,e.lon);if(!o?.length){r.status="No branches returned";return}let n=null;o.forEach(t=>{const i=Number(t.longitude??t.Longitude),c=Number(t.latitude??t.Latitude),B=Number(t.distance??t.Distance??0);Number.isFinite(i)&&Number.isFinite(c)&&(f(i,c,`<div id="popup">Branch #${t.id??t.Id}</div>
               <div>${t.street??t.Street??""}, ${t.city??t.City??""} ${t.region??t.Region??""}<br/>
               ${B.toFixed(2)} mi</div>`),n?n.extend([i,c]):n=new window.tt.LngLatBounds([i,c],[i,c]))}),n&&(a.fitBounds(n,{padding:80,duration:500}),a.easeTo({zoom:a.getZoom()-.7,duration:300})),r.status=""}catch(e){console.error(e),r.status=typeof e?.message=="string"?e.message:"Unexpected error"}};return j(()=>{s&&(s.remove(),s=null)}),{mapRef:l,state:r,findClosestBranches:y}}},P={class:"text-center q-mt-md"},U={ref:"mapRef",style:{height:"50vh",width:"90vw","margin-left":"5vw",border:"solid"}},V={key:0,class:"status q-mt-md text-subtitle2 text-negative"};function b(l,s,r,d,m,f){return w(),p("div",P,[s[1]||(s[1]=h("div",{class:"text-h4"},"Find 3 Closest Branches To:",-1)),g(N,{class:"q-ma-lg text-h5",placeholder:"enter current address or postal code",modelValue:d.state.address,"onUpdate:modelValue":s[0]||(s[0]=u=>d.state.address=u),id:"address"},null,8,["modelValue"]),g(x,{label:"FIND 3",onClick:d.findClosestBranches,class:"q-mb-md",style:{width:"30vw"}},null,8,["onClick"]),_(h("div",U,null,512),[[C,d.state.showmap===!0]]),d.state.status?(w(),p("div",V,T(d.state.status),1)):$("",!0)])}const q=A(E,[["render",b],["__scopeId","data-v-2325835c"]]);export{q as default};
