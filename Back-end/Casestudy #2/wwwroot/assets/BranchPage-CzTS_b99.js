import{Q as N}from"./QInput-CHmXElOw.js";import{Q as U}from"./QBtn-BlTpD4Mn.js";import{O as k,q as C,x as f,t as E,v as z,P as I,ah as S,y as _,r as j,f as O}from"./index-CV0ljbTk.js";import{_ as R}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-key-composition-C-TLG6aN.js";import"./focus-manager-D6b46Wbj.js";const G={name:"BranchePage",setup(){const m=j(null);let t=O({status:"",address:"T5A 0A3",showmap:!1});return{mapRef:m,state:t,findClosestBranches:async()=>{try{t.status="Finding branches...",t.showmap=!0;const e=window.tt;let r=t.address.trim();if(r.match(/^[A-Za-z]\d[A-Za-z][\s-]?\d[A-Za-z]\d$/)){let o=r.replace(/[-\s]/g,"");r=o.substring(0,3)+" "+o.substring(3)}console.log("Searching for:",r);let h=`https://api.tomtom.com/search/2/geocode/${encodeURIComponent(r)}.json?key=Hyxyimv7jPnUdwKFnzcAcAcjaUQEWPzB`;console.log("Geocoding URL:",h);let n=await fetch(h);if(console.log("Geocoding response status:",n.status),console.log("Geocoding response headers:",[...n.headers]),!n.ok){let o=await n.text();throw console.log("Geocoding error response:",o),new Error(`TomTom geocoding failed: ${n.status} - ${o}`)}let a=await n.json();if(console.log("Full geocoding response:",a),!a.results||a.results.length===0)throw new Error(`No geocoding results found for: ${r}`);let d=parseFloat(a.results[0].position.lat),c=parseFloat(a.results[0].position.lon);console.log("Geocoded coordinates:",d,c),console.log("Found location:",a.results[0].address?.freeformAddress);const x=JSON.parse(sessionStorage.getItem("customer")||"{}");if(!x.token){t.status="Please login first to find branches";return}let A=`/api/Branch/${d}/${c}`;console.log("Branch API URL:",A);let i=await fetch(A,{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+x.token}});if(console.log("Branch response status:",i.status),!i.ok){const o=await i.text();throw console.log("Branch API error response:",o),new Error(`Branch API error: ${i.status} - ${o}`)}let g=await i.text();console.log("Branch API response:",g);let l;try{l=JSON.parse(g)}catch(o){throw console.error("JSON parse error:",o),new Error(`Invalid JSON response: ${g}`)}if(console.log("Parsed branches:",l),!l||l.length===0){t.status="No branches found";return}let u=e.map({key:"Hyxyimv7jPnUdwKFnzcAcAcjaUQEWPzB",container:m.value,source:"vector/1/basic-main",center:[c,d],zoom:10});u.addControl(new e.FullscreenControl),u.addControl(new e.NavigationControl);const w=new e.LngLatBounds;let T=new e.Marker({color:"red"}).setLngLat([c,d]).addTo(u),P=new e.Popup({offset:25});P.setHTML(`<div>Search Location<br/>${r}</div>`),T.setPopup(P),w.extend([c,d]);const p={};l.forEach(o=>{const s=`${o.latitude},${o.longitude}`;p[s]||(p[s]=[]),p[s].push(o)}),Object.values(p).forEach(o=>{o.forEach((s,y)=>{let v=s.latitude,B=s.longitude;o.length>1&&(v+=y*5e-4,B+=y*5e-4),w.extend([B,v]);let F=new e.Marker().setLngLat([B,v]).addTo(u),b=25,$=new e.Popup({offset:b});$.setHTML(`<div id="popup">Branch# ${s.id}</div><div>${s.street}, ${s.city}<br/>${s.distance.toFixed(2)} km</div>`),F.setPopup($)})}),u.fitBounds(w,{padding:50,maxZoom:15}),t.status=`Found ${l.length} closest branches`}catch(e){console.error("Branch finding error:",e),t.status=`Error: ${e.message}`}}}}},Q={class:"text-center q-mt-md"},V={style:{height:"50vh",width:"90vw","margin-left":"5vw",border:"solid"},ref:"mapRef"},q={key:0,class:"status q-mt-md text-subtitle2 text-negative"};function M(m,t,L,e,r,h){return C(),k("div",Q,[t[2]||(t[2]=f("div",{class:"text-h4"},"Find 3 Closest Branches To:",-1)),f("div",null,[E(N,{class:"q-ma-lg text-h5",placeholder:"enter current address",id:"address",modelValue:e.state.address,"onUpdate:modelValue":t[0]||(t[0]=n=>e.state.address=n)},null,8,["modelValue"]),t[1]||(t[1]=f("br",null,null,-1))]),E(U,{label:"FIND 3",onClick:e.findClosestBranches,class:"q-mb-md",style:{width:"30vw"}},null,8,["onClick"]),z(f("div",V,null,512),[[S,e.state.showmap===!0]]),e.state.status?(C(),k("div",q,_(e.state.status),1)):I("",!0)])}const Y=R(G,[["render",M]]);export{Y as default};
