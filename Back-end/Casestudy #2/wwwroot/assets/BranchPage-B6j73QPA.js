import{Q as P}from"./QInput-BHX0fwOU.js";import{Q as k}from"./QBtn-DKfwd5pi.js";import{O as y,q as B,x as c,t as x,v as $,P as N,ah as S,y as F,r as U,f as b}from"./index-yFJL1u_v.js";import{_ as z}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-key-composition-B7SPPOI6.js";import"./focus-manager-CyAyyM1-.js";const E={name:"BranchePage",setup(){const p=U(null);let e=b({status:"",address:"T5A 0A3",showmap:!1});const g=async()=>{try{e.status="Finding branches...",e.showmap=!0;const t=window.tt;let o=e.address.trim();if(o.match(/^[A-Za-z]\d[A-Za-z][\s-]?\d[A-Za-z]\d$/)){let s=o.replace(/[-\s]/g,"");o=s.substring(0,3)+" "+s.substring(3),o+=", Canada"}console.log("Searching for:",o);let n=`https://api.tomtom.com/search/2/geocode/${encodeURIComponent(o)}.json?key=Hyxyimv7jPnUdwKFnzcAcAcjaUQEWPzB&countrySet=CA&limit=1`;console.log("Geocoding URL:",n);let a=await(await fetch(n)).json();if(console.log("Geocoding response:",a),!a.results||a.results.length===0){e.status=`Address not found. API returned: ${JSON.stringify(a)}`;return}let u=parseFloat(a.results[0].position.lat),m=parseFloat(a.results[0].position.lon);console.log("Coordinates found:",u,m);let f=`/api/Branch/${u}/${m}`;console.log("Branch API URL:",f);let d=await fetch(f,{method:"GET",headers:{"Content-Type":"application/json",...r()}});if(!d.ok)throw new Error(`Branch API error: ${d.status} - ${d.statusText}`);let h=await d.text();console.log("Branch API response:",h);let l;try{l=JSON.parse(h)}catch(s){throw console.error("JSON parse error:",s),new Error(`Invalid JSON response: ${h}`)}if(!l||l.length===0){e.status="No branches found";return}let i=t.map({key:"Hyxyimv7jPnUdwKFnzcAcAcjaUQEWPzB",container:p.value,source:"vector/1/basic-main",center:[m,u],zoom:8});i.addControl(new t.FullscreenControl),i.addControl(new t.NavigationControl);const w=new t.LngLatBounds;l.forEach(s=>{w.extend([s.longitude,s.latitude]);let A=new t.Marker().setLngLat([s.longitude,s.latitude]).addTo(i),C=25,v=new t.Popup({offset:C});v.setHTML(`<div id="popup">Branch# ${s.id}</div><div>${s.street}, ${s.city}<br/>${s.distance.toFixed(2)} km</div>`),A.setPopup(v)}),i.fitBounds(w,{padding:50,maxZoom:12}),e.status=`Found ${l.length} closest branches`}catch(t){console.error("Branch finding error:",t),e.status=`Error: ${t.message}`}},r=()=>{const t=new Headers;t.append("Content-Type","application/json");const o=sessionStorage.getItem("customer");if(o)try{const n=JSON.parse(o);n?.token&&t.append("Authorization","Bearer "+n.token)}catch{}return t};return{mapRef:p,state:e,findClosestBranches:g}}},I={class:"text-center q-mt-md"},T={style:{height:"50vh",width:"90vw","margin-left":"5vw",border:"solid"},ref:"mapRef"},_={key:0,class:"status q-mt-md text-subtitle2 text-negative"};function j(p,e,g,r,t,o){return B(),y("div",I,[e[2]||(e[2]=c("div",{class:"text-h4"},"Find 3 Closest Branches To:",-1)),c("div",null,[x(P,{class:"q-ma-lg text-h5",placeholder:"enter current address",id:"address",modelValue:r.state.address,"onUpdate:modelValue":e[0]||(e[0]=n=>r.state.address=n)},null,8,["modelValue"]),e[1]||(e[1]=c("br",null,null,-1))]),x(k,{label:"FIND 3",onClick:r.findClosestBranches,class:"q-mb-md",style:{width:"30vw"}},null,8,["onClick"]),$(c("div",T,null,512),[[S,r.state.showmap===!0]]),r.state.status?(B(),y("div",_,F(r.state.status),1)):N("",!0)])}const J=z(E,[["render",j]]);export{J as default};
