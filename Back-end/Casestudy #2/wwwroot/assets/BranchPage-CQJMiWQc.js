import{Q as A}from"./QInput-CprZgOKJ.js";import{Q as b}from"./QBtn-BF-ru_Qd.js";import{O as $,q as y,x as i,t as C,v as k,P,ah as F,y as N,r as T,f as _}from"./index-Cu0Ds661.js";import{_ as E}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-key-composition-CGkZ7a3a.js";import"./focus-manager-BPfUA_tb.js";const I={name:"BranchePage",setup(){const c=T(null);let e=_({status:"",address:"T5A-0A3",showmap:!1});const f=async()=>{try{e.status="Finding branches...",e.showmap=!0;const t=window.tt;let a=e.address;if(e.address.match(/^[A-Za-z]\d[A-Za-z][\s-]?\d[A-Za-z]\d$/)){let s=e.address.replace(/[-\s]/g,"");a=`${s.substring(0,3)+" "+s.substring(3)}, Canada`}let n=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&countrycodes=ca&limit=1`,d=await(await fetch(n)).json();if(!d||d.length===0){e.status="Address not found";return}let p=parseFloat(d[0].lat),m=parseFloat(d[0].lon);console.log(`Geocoded address: ${a} -> Lat: ${p}, Lon: ${m}`);let g=`/api/Branch/${p}/${m}`;console.log(`Calling branch API: ${g}`);let l=await fetch(g,{method:"GET",headers:{"Content-Type":"application/json",...o()}});if(console.log(`Branch API response status: ${l.status}`),!l.ok)throw new Error(`Branch API error: ${l.status} - ${l.statusText}`);let u=await l.text();console.log("Raw branch response:",u);let r;try{r=JSON.parse(u)}catch(s){throw console.error("JSON parse error:",s),new Error(`Invalid JSON response: ${u}`)}if(!r||r.length===0){e.status="No branches found";return}console.log(`Found ${r.length} branches:`,r);let h=t.map({key:"Hyxyimv7jPnUdwKFnzcAcAcjaUQEWPzB",container:c.value,source:"vector/1/basic-main",center:[m,p],zoom:10});h.addControl(new t.FullscreenControl),h.addControl(new t.NavigationControl),r.forEach((s,w)=>{console.log(`Adding marker for branch ${w+1}:`,s);let B=new t.Marker().setLngLat([s.longitude,s.latitude]).addTo(h),x=25,v=new t.Popup({offset:x});v.setHTML(`<div id="popup">Branch# ${s.id}</div><div>${s.street}, ${s.city}<br/>${s.distance.toFixed(2)} km</div>`),B.setPopup(v)}),e.status=`Found ${r.length} closest branches`}catch(t){console.error("Branch finding error:",t),e.status=`Error: ${t.message}`}},o=()=>{const t=new Headers;t.append("Content-Type","application/json");const a=sessionStorage.getItem("customer");if(a)try{const n=JSON.parse(a);n?.token&&t.append("Authorization","Bearer "+n.token)}catch{}return t};return{mapRef:c,state:e,findClosestBranches:f}}},S={class:"text-center q-mt-md"},z={style:{height:"50vh",width:"90vw","margin-left":"5vw",border:"solid"},ref:"mapRef"},R={key:0,class:"status q-mt-md text-subtitle2 text-negative"};function j(c,e,f,o,t,a){return y(),$("div",S,[e[2]||(e[2]=i("div",{class:"text-h4"},"Find 3 Closest Branches To:",-1)),i("div",null,[C(A,{class:"q-ma-lg text-h5",placeholder:"enter current address",id:"address",modelValue:o.state.address,"onUpdate:modelValue":e[0]||(e[0]=n=>o.state.address=n)},null,8,["modelValue"]),e[1]||(e[1]=i("br",null,null,-1))]),C(b,{label:"FIND 3",onClick:o.findClosestBranches,class:"q-mb-md",style:{width:"30vw"}},null,8,["onClick"]),k(i("div",z,null,512),[[F,o.state.showmap===!0]]),o.state.status?(y(),$("div",R,N(o.state.status),1)):P("",!0)])}const J=E(I,[["render",j]]);export{J as default};
